<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv='content-type' content='text/html; charset=UTF-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
        <title>Badger, badger, badger, mushroom, mushroom!</title>
        <!--[if lt IE 9]>
            <script src='https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js'></script>
        <![endif]-->
        <style type='text/css'>
            #container { width: 100%; overflow: hidden; }
            .draggable { cursor: move; }
            .menu {
                background-color: #EEEEDD; border: 1px solid #CCC;
                display: inline-block; padding: 2px; border-radius: 3px; }
            .badge { float: left; }
            .closeBtn { float: right; position: relative; right: 25px; top: 25px; }
            .hidden { display: none; }
            @media print { .no-print, .no-print * { display: none !important; } }
        </style>

    <script type='text/javascript' src="http://knockoutjs.com/downloads/knockout-3.2.0.js" integrity="sha384-BfEcYlFlmy59EmR8p6lVNayGRn4Vzo2Y1T6V3xZdD5cVel+d7NobZlyxT3RkNUaW" crossorigin="anonymous"></script>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js'></script>
</head>
<body>
<div id='container'>
    <span class='no-print'>Badges (<a href='#' data-bind='click: newBadge()'>add badge</a>)</span>
    <div data-bind='foreach: badges'>
        <!--<a href='#' data-bind='click: addChild('TEST')'>Add child</a>-->
        <!--<span class='renderTime' data-bind='visible: $root.showRenderTimes'>
            (person rendered at <span data-bind='text: new Date().getSeconds()' > </span>)
        </span>-->
        
        <div class='badge' data-bind='html: getHtml()'>Loading..</div>
        <div class='menu no-print' data-bind='visible: showMenu'>
            <input data-bind='attr: {id: "editor" + data._id}' type='text' placeholder='Select field to edit'>
        </div>
    </div><!--/foreach badges-->
</div>
<script type='text/javascript'>
var defaultBadgeTpl = _.template('Loading...');
var badgeCounter = 0;

var Badge = function() {
    this.showMenu = true;
    this.data = {
        _id: badgeCounter++,
        upper_text: "Harebo '16",
        upper_path: "M 80, 150 c 0, -100, 140, -100, 140, 0",
        middle_text: "SÃ¸borg",
        lower_text: "C. Software",
        lower_path: "M 60, 150 c 0, 120, 180, 120, 180, 0"
    };
    console.log('New badge with id: ' + this.data._id);
    this.getHtml = function() {
        return defaultBadgeTpl(this.data);
    }
}

var viewModel = {
    badges: ko.observableArray([ /* empty as newBadge is called (when rendering?!) */ ]),
    newBadge: function() {
    	this.badges.push(new Badge());
    },
    deleteBadge: function (id) {
    	_.each(this.badges, function(badge) {
    		if (badge.data()._id == id) {
            	//TODO: Remove 'badge'
            	console.log("TODO: Remove " + badge);
        	}
    	});
	}
};


// Helper functions:
function edit(id, attr) {
    var editor = document.getElementById('editor' + id);
    //var elm = document.getElementById(attr + id);
    //editor.value = elm.textContent;
    var badge = viewModel.badges()[id];
    editor.value = badge.data[attr];

    // TODO: remove any event handlers from editor
    editor.addEventListener('keyup', function() {
        //elm.textContent = editor.value;
        badge.data[attr] = editor.value;
    });
};


// GET DEFAULT TEMPLATE:
var request = new XMLHttpRequest();
request.open('GET', 'badge.tpl', true);
request.onload = function() {
    defaultBadgeTpl = _.template(this.response);
    ko.applyBindings(viewModel); // show badges
}
request.send();
</script>
</body>
</html>
