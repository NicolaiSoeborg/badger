<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="author" content="Nicolai Søborg">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Badger, badger, badger, mushroom, mushroom! &mdash; badger2.søb.org &#8480;</title>
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
	<![endif]-->
	<style type="text/css">
		#container { width: 100%; overflow: hidden; }
		#menu {
			background-color: #EEEEDD; border: 1px solid #CCC; width: 200px;
			display: inline-block; padding: 5px; border-radius: 3px; }
		.badge { float: left; }
		.draggable { cursor: move; }
		.closeBtn { float: right; position: relative; right: 25px; top: 25px; }
		.hidden { display: none; }
		@media print { .no-print, .no-print * { display: none !important; } }
	</style>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js" integrity="sha384-/EjRuG6YTb6zCFou+DBnYCi5u9E1RjUMJanyGOL7DUYLp6wSCUuHNhd58uoGj7jh" crossorigin="anonymous"></script> 
</head>
<body>
<div id="container">
	<span class="no-print">
		<strong>Badger!</strong>
		<a href="#" data-bind="click: newBadge">add badge</a>,
		<a href="#" id="togglePrint" data-bind="click: togglePrint">prepare print</a>
	</span>

	<!-- Define globale styles for badges
	Every elm. with a non-unique "id" attribute should be listed below -->
	<svg version="1.1" width="0" height="0" xmlns="http://www.w3.org/2000/svg">
		<defs>
			<clipPath id="badge-cutoff">
				<circle data-bind="attr: $root.badges()[0].circle" r="2.5cm" />
			</clipPath>
			<clipPath id="badge-full">
				<circle data-bind="attr: $root.badges()[0].circle" r="3.0cm" />
			</clipPath>
		</defs>
	</svg>

	<!-- Create badges -->
	<div data-bind="foreach: badges">
		<div data-bind="attr: {badgeId: _id}" class="badge">
			<button class="closeBtn no-print" data-bind="visible: $root.showMenu /*, click: $root.deleteBadge(_id)*/" onclick="viewModel.deleteBadge(this.parentElement)" title="Delete badge">X</button>
			<svg version="1.1" baseProfile="full" width="300" height="300" xmlns="http://www.w3.org/2000/svg">
				<defs>
					<path data-bind="attr: {id: 'upper-path' + _id, d: upper_attr.d}" />
					<path data-bind="attr: {id: 'lower-path' + _id, d: lower_attr.d}" />
				</defs>

				<!-- 'Actual' badge (when designing): -->
				<image data-bind="attr: img, visible: $root.showMenu" clip-path="url(#badge-cutoff)" />
				<!-- Actual badge (when printing): -->
				<image data-bind="attr: img, visible: !$root.showMenu()" clip-path="url(#badge-full)" />
				<!-- Badge background: -->
				<image data-bind="attr: img, visible: $root.showMenu, event: { mousedown: beginMove, mousemove: doMove, mouseup: stopMove }" style="opacity: 0.2" class="draggable no-print" />

				<!-- The outermost circle (always visible): -->
				<circle ondblclick="viewModel.changeBackground(this.parentElement.parentElement)" cx="150" cy="150" r="3cm" stroke="black" stroke-width="0.1mm" stroke-dasharray="5,5" fill="transparent" />

				<text>
					<textPath data-bind="attr: upper_attr" onclick="viewModel.editBadge(this)">Harebo '16</textPath>
					<textPath data-bind="attr: lower_attr" onclick="viewModel.editBadge(this)">C. Software</textPath>
				</text>
				<text data-bind="attr: middle_attr" onclick="viewModel.editBadge(this)">Søborg</text>
			</svg>
			<br />
			<input type="file" accept="image/*" data-bind="attr: {id: 'fileSelect' + _id}" class="hidden" />
			<span class="no-print" data-bind="visible: $root.showMenu">
				Scale: <input type="range" min="0.1" max="5" step="0.1" data-bind="value: imgScale"/>
			</span>
		</div>
	</div><!--/foreach badges-->
	<div id="menu" data-bind="visible: showMenu()" class="no-print">&larr; Click any element on the badge to change content.<br />
	Tips: double-click inside the badge (not on the text) to change background.</div>
</div>
<script type="text/javascript">
var badgeCounter = 0,
	viewModel = null, // needed to defined before imgScale
	FONTS = ["Times New Roman", "Helvetica", "Arial", "Comic Sans MS",
			 "Segoe Print", "Terminal", "Impact", "Tahoma", "Wingdings"];

var Badge = function(badgeId) {
	var obj = {
		_id: badgeId,
		upper_attr: {
			d: "M 80, 150 c 0, -100, 140, -100, 140, 0",
			href: "#upper-path" + badgeId,
			textContent: "Harebo '16",
		},
		middle_attr: {
			textContent: "Søborg",
			x: 150,
			y: 175,
		},
		lower_attr: {
			d: "M 60, 150 c 0, 120, 180, 120, 180, 0",
			href: "#lower-path" + badgeId,
			textContent: "C. Software",
		},
		circle: {
			cx: 150,
			cy: 150,
			stroke: "black",
		},
		imgScale: ko.computed({
			read: function() { return 1; },
			write: function(value) {
				viewModel.badges().forEach(function(badge) {
					if (badge._id == badgeId) {
						badge.img.height( 400 * value );
						badge.img.width( 400 * value );
					}
				});
			}
		}),
		img: {
			href: ko.observable("picture_bg.jpg"),
			x: ko.observable(-50),
			y: ko.observable(-50),
			height: ko.observable(400),
			width: ko.observable(400),
		},
		mouseCoord: {x: 0, y: 0}, // "private" holder for mouse movement
		isMouseMoving: false,
		beginMove: function() {
			this.mouseCoord.x = event.clientX;
			this.mouseCoord.y = event.clientY;
			this.isMouseMoving = true;
		},
		doMove: function() {
			if (this.isMouseMoving) {
				var diffX = event.clientX - this.mouseCoord.x,
					diffY = event.clientY - this.mouseCoord.y;
				this.img.x(this.img.x() + diffX);
				this.img.y(this.img.y() + diffY);
				// Reset mouse coords:
				this.mouseCoord.x = event.clientX;
				this.mouseCoord.y = event.clientY;
			}
		},
		stopMove: function() {
			this.isMouseMoving = false;
		}
	};
	// Please fix this:
	for (attr of [obj.upper_attr, obj.lower_attr]) {
		attr["font-size"] = 25;
		attr["startOffset"] = "50%";
	};
	obj.middle_attr["font-size"] = 60;
	for (attr of [obj.upper_attr, obj.middle_attr, obj.lower_attr]) {
		attr["fill"] = "#FFFFFF"; // white
		attr["text-anchor"] = "middle";
		attr["font-family"] = "Tahoma";
	}
	return obj;
}

viewModel = {
	badges: ko.observableArray([ new Badge(badgeCounter) ]),
	newBadge: function() {
		this.badges.push(new Badge(badgeCounter++) );
	},
	deleteBadge: function(b) {
		if (this.badges().length == 1) {
			document.getElementById("menu").innerHTML = "Can't delete the last badge!";
			return;
		}

		var badgeId = b.attributes.badgeId.value, vm = this;
		this.badges().forEach(function(badge) {
			if (badge._id == badgeId) {
				vm.badges.remove(badge);
			}
		});
	},
	editBadge: function(elm) {
		var attr = elm.attributes;
		var menu = document.getElementById("menu");
		var disabledElms = ["onclick", "data-bind", "href", "d"];

		menu.innerHTML = "<center><strong>MENU</strong></center>"; // delete old menu

		for (i = 0; i < attr.length; i++) {
			var elmName = attr[i].name, elmVal = attr[i].value;

			// Skip stuff user shouldn't change:
			if (disabledElms.indexOf(elmName) > -1)
				continue;

			// Create an input form for changing value (TODO: nicer menu)
			var label = document.createElement("LABEL");
			label.setAttribute("for", elmName);
			label.textContent = elmName + ": ";

			var input = document.createElement("INPUT");
			if (elmName == "font-family") {
				input = document.createElement("SELECT");
				for (font of FONTS) {
					var opt = document.createElement("OPTION");
					opt.text = font;
					opt.style.fontFamily = font;
					opt.setAttribute("value", font);
					if (font == elmVal)
						opt.setAttribute("selected", true);

					input.appendChild(opt);
				}
			} else {
				input.setAttribute("value", elmVal);
			}

			input.setAttribute("name", elmName);
			var valType = elmVal[0] == "#" ? "color" : isNaN(attr[i].value) ? "string" : "number";
			input.setAttribute("type", valType);
			input.style.width = "100%";

			// Make sure to userinput will update visible design:
			for (fuckJS of ["onchange", "onkeydown", "onpaste", "oninput"]) {
				input[fuckJS] = function() {
					if (this.name == "textContent") {
						elm.textContent = this.value;
						// Make sure "deleted" textfields still can be selected:
						if (elm.textContent == "")
							elm.innerHTML = "&nbsp;&nbsp;";
					}
					elm.attributes[this.name].value = this.value;
				}
			}

			// Append 'input line' to menu:
			menu.appendChild(label);
			menu.appendChild(input);
			menu.appendChild(document.createElement("BR"));
		}

		menu.appendChild(document.createElement("BR"));
	},
	showMenu: ko.observable(true),
	togglePrint: function() {
		var showMenu = this.showMenu();
		// Update text
		document.getElementById("togglePrint").textContent = showMenu ? "show menu" : "prepare print";

		// Toggle value:
		this.showMenu(!showMenu);
	},
	changeBackground: function(b) {
		var badgeId = b.attributes.badgeId.value;
		this.badges().forEach(function(badge) {
			if (badge._id == badgeId) {
				var f = document.getElementById("fileSelect" + badgeId);
				f.onchange = function(){
					var reader = new FileReader();
					// What to do when loading of data is done:
					reader.onload = function(event) {
						badge.img.href(event.target.result);
					}
					// Begin loading data (async)
					reader.readAsDataURL(this.files[0]);
				};
				f.click(); // activate "select file" diag
			}
		});
	},
};

ko.applyBindings(viewModel);
</script>
</body>
</html>
